const createFuncMessage = global.utils.message;
const handlerCheckDB = require("./handlerCheckData.js");

const request = require("request");
const axios = require("axios");
const fs = require("fs-extra");

module.exports = (api, threadModel, userModel, dashBoardModel, globalModel, usersData, threadsData, dashBoardData, globalData) => {
    const handlerEvents = require(
        process.env.NODE_ENV == 'development' ?
            "./handlerEvents.dev.js" :
            "./handlerEvents.js"
    )(api, threadModel, userModel, dashBoardModel, globalModel, usersData, threadsData, dashBoardData, globalData);

    return async function (event) {
        const message = createFuncMessage(api, event);

        await handlerCheckDB(usersData, threadsData, event);
        const handlerChat = await handlerEvents(event, message);
        if (!handlerChat) return;

        const {
            onStart,
            onChat,
            onReply,
            onEvent,
            handlerEvent,
            onReaction,
            typ,
            presence,
            read_receipt
        } = handlerChat;

        switch (event.type) {

            case "message":
            case "message_reply":
            case "message_unsend":
                onChat();
                onStart();
                onReply();

                // ================================
                // 🔄 RESEND SYSTEM FOR UNSENT MESSAGE
                // ================================
                if (event.type == "message_unsend") {

                    let resend = await threadsData.get(event.threadID, "settings.reSend");

                    if (resend == true && event.senderID !== api.getCurrentUserID()) {

                        let umid = global.reSend[event.threadID].findIndex(
                            e => e.messageID === event.messageID
                        );

                        if (umid > -1) {
                            let nname = await usersData.getName(event.senderID);
                            let attch = [];

                            if (global.reSend[event.threadID][umid].attachments.length > 0) {

                                let cn = 0;

                                for (var abc of global.reSend[event.threadID][umid].attachments) {

                                    if (abc.type == "audio") {

                                        cn += 1;
                                        let pts = `scripts/cmds/tmp/${cn}.mp3`;

                                        let res2 = (await axios.get(abc.url, {
                                            responseType: "arraybuffer"
                                        })).data;

                                        fs.writeFileSync(pts, Buffer.from(res2, "utf-8"));
                                        attch.push(fs.createReadStream(pts));

                                    } else {
                                        attch.push(await global.utils.getStreamFromURL(abc.url));
                                    }
                                }
                            }

                            api.sendMessage({
                                body: `${nname} removed:\n\n${global.reSend[event.threadID][umid].body}`,
                                mentions: [{ id: event.senderID, tag: nname }],
                                attachment: attch
                            }, event.threadID);
                        }
                    }
                }
                break;

            // ================================
            // 🔵 EVENT HANDLER
            // ================================
            case "event":
                handlerEvent();
                onEvent();
                break;

            // ================================
            // 💬 REACTION SYSTEM (Fully Fixed)
            // ================================
            case "message_reaction":
                onReaction();

                // Get admin list from config
                const adminList = global.GoatBot?.config?.adminBot || [];

                // ⚠️ Reaction → remove the user (Allowed only for admins)
                if (event.reaction == "⚠️") {

                    if (adminList.includes(event.userID)) {

                        api.removeUserFromGroup(event.senderID, event.threadID, (err) => {
                            if (err) console.log(err);
                        });

                    } else {
                        message.send(":)");
                    }
                }

                // 😠 Reaction → unsend bot's message (Only admins can trigger)
                if (event.reaction == "😠") {

                    // Bot only reacts if it originally sent this message
                    if (event.senderID == api.getCurrentUserID()) {

                        if (adminList.includes(event.userID)) {
                            message.unsend(event.messageID);
                        } else {
                            message.send(":)");
                        }
                    }
                }

                break;

            // ================================
            // ✏️ USER TYPING INDICATOR
            // ================================
            case "typ":
                typ();
                break;

            // ================================
            // 👁️ PRESENCE UPDATE
            // ================================
            case "presence":
                presence();
                break;

            // ================================
            // 📖 READ RECEIPT
            // ================================
            case "read_receipt":
                read_receipt();
                break;

            default:
                break;
        }
    };
};
